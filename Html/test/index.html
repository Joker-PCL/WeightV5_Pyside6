<!DOCTYPE html>
<html lang="en">
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, height=device-height,initial-scale=0.6, minimum-scale=0.6, maximum-scale=0.6"
    />
    <title>Table Display</title>
    <!-- font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300&display=swap"
      rel="stylesheet"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <!-- canvasjs -->
    <script
      type="text/javascript"
      src="https://cdn.canvasjs.com/canvasjs.min.js"
    ></script>

    <!-- fontawesome -->
    <script
      src="https://kit.fontawesome.com/4a1626448e.js"
      crossorigin="anonymous"
    ></script>

    <!-- autocomplete jquery -->
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

    <!-- sweetalert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.2/moment.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css"
    />

    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="autocomplete.css" />
  </head>

  <body>
    <!-- loading edit -->
    <div class="loading-edit">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        height="200px"
        width="200px"
        viewBox="0 0 200 200"
        class="pencil"
      >
        <defs>
          <clippath id="pencil-eraser">
            <rect height="30" width="30" ry="5" rx="5"></rect>
          </clippath>
        </defs>
        <circle
          transform="rotate(-113,100,100)"
          stroke-linecap="round"
          stroke-dashoffset="439.82"
          stroke-dasharray="439.82 439.82"
          stroke-width="2"
          stroke="currentColor"
          fill="none"
          r="70"
          class="pencil-stroke"
        ></circle>
        <g transform="translate(100,100)" class="pencil-rotate">
          <g fill="none" class="pencil-body">
            <circle
              transform="rotate(-90)"
              stroke-dashoffset="402"
              stroke-dasharray="402.12 402.12"
              stroke-width="30"
              stroke="hsl(223,90%,50%)"
              r="64"
              class="pencil-body1"
            ></circle>
            <circle
              transform="rotate(-90)"
              stroke-dashoffset="465"
              stroke-dasharray="464.96 464.96"
              stroke-width="10"
              stroke="hsl(223,90%,60%)"
              r="74"
              class="pencil-body2"
            ></circle>
            <circle
              transform="rotate(-90)"
              stroke-dashoffset="339"
              stroke-dasharray="339.29 339.29"
              stroke-width="10"
              stroke="hsl(223,90%,40%)"
              r="54"
              class="pencil-body3"
            ></circle>
          </g>
          <g transform="rotate(-90) translate(49,0)" class="pencil-eraser">
            <g class="pencil-eraser-skew">
              <rect
                height="30"
                width="30"
                ry="5"
                rx="5"
                fill="hsl(223,90%,70%)"
              ></rect>
              <rect
                clip-path="url(#pencil-eraser)"
                height="30"
                width="5"
                fill="hsl(223,90%,60%)"
              ></rect>
              <rect height="20" width="30" fill="hsl(223,10%,90%)"></rect>
              <rect height="20" width="15" fill="hsl(223,10%,70%)"></rect>
              <rect height="20" width="5" fill="hsl(223,10%,80%)"></rect>
              <rect
                height="2"
                width="30"
                y="6"
                fill="hsla(223,10%,10%,0.2)"
              ></rect>
              <rect
                height="2"
                width="30"
                y="13"
                fill="hsla(223,10%,10%,0.2)"
              ></rect>
            </g>
          </g>
          <g transform="rotate(-90) translate(49,-30)" class="pencil-point">
            <polygon points="15 0,30 30,0 30" fill="hsl(33,90%,70%)"></polygon>
            <polygon points="15 0,6 30,0 30" fill="hsl(33,90%,50%)"></polygon>
            <polygon
              points="15 0,20 10,10 10"
              fill="hsl(223,10%,10%)"
            ></polygon>
          </g>
        </g>
      </svg>
    </div>

    <!-- loading page -->
    <div class="loading-page">
      <section class="loader">
        <div class="slider" style="--i: 0"></div>
        <div class="slider" style="--i: 1"></div>
        <div class="slider" style="--i: 2"></div>
        <div class="slider" style="--i: 3"></div>
        <div class="slider" style="--i: 4"></div>

        <!-- <span>กำลังอัพเดทข้อมูล</span> -->
      </section>
    </div>

    <!-- loading trash -->
    <div class="loading-trash">
      <section>
        <span class="trash">
          <span></span>
          <i></i>
        </span>
      </section>
    </div>

    <main>
      <nav class="navbar bg-primary sticky-top py-1">
        <div class="container-fluid">
          <a class="navbar-brand text-white fw-bold fs-2 ms-2">Polipharm</a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#sidebar_menu"
            aria-controls="sidebar_menu"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div
            class="offcanvas offcanvas-end"
            tabindex="-1"
            id="sidebar_menu"
            aria-labelledby="sidebarLabel"
          >
            <div class="offcanvas-header">
              <h4
                class="offcanvas-title fw-bolder text-decoration-underline"
                id="sidebarLabel"
              >
                โปรแกรมบันทึกข้อมูลน้ำหนักยา
              </h4>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="offcanvas"
                aria-label="Close"
              ></button>
            </div>
            <div class="offcanvas-body" id="sidebar_body"></div>
            <footer class="d-flex flex-row m-2">
              <button type="button" id="logout" class="btn btn-danger">
                ออกจากระบบ
              </button>
            </footer>
          </div>
        </div>
      </nav>

      <section class="pages container-xxl">
        <div class="page" data-toggle="home_page">
          <div class="page-main-container">
            <div id="home_page" class="page-container">
              <p class="page-title">
                ยินดีต้อนรับคุณ ณัฐพล สิทธิการใช้งาน Superuser
              </p>
              <iframe
                style="border: none"
                src="https://whimsical.com/embed/RLsLUSn5w5v9VKw5bFDJbM"
              ></iframe>
            </div>
          </div>
        </div>

        <div class="page active" data-toggle="weight_10s_page">
          <p class="page-title">ตารางข้อมูลน้ำหนักยา 10 เม็ด</p>
          <div id="container10s" class="weight-container"></div>
        </div>

        <div class="page" data-toggle="weight_ipc_page">
          <p class="page-title">
            การควบคุมน้ำหนักเฉลี่ย (AVERAGE WEIGHT)
            <br />
            และน้ำหนักเบี่ยงเบนของเม็ดยา (WEIGHT VARIATION)
          </p>
          <div id="containerIpc" class="weight-container"></div>
        </div>

        <div class="page" data-toggle="weighing_setup_page">
          <div class="form-main-container">
            <div id="weighing_setup" class="form-container">
              <p class="page-title">ตั้งค่าน้ำหนักยาของเครื่องตอก</p>
            </div>
          </div>
        </div>

        <div class="page" data-toggle="weighing_database_page">
          <div class="form-main-container">
            <div id="weighing_database" class="form-container">
              <p class="page-title">แก้ไขฐานข้อมูลน้ำหนักยา</p>
            </div>
          </div>
        </div>

        <div class="page" data-toggle="user_database_page">
          <div class="form-main-container">
            <div id="user_edit" class="form-container">
              <p class="page-title">แก้ไขรายชื่อผู้ปฏิบัติงาน</p>

              <div class="form-detail">
                <ol>
                  <li class="lh-lg">
                    ต้องการแก้ไขข้อมูลให้ทำการเลือกที่ รายชือพนักงาน
                  </li>
                  <li class="lh-lg">
                    ต้องการเพิ่มข้อมูลให้กรอกข้อมูลแล้วกดบันทึก
                  </li>
                  <li class="lh-lg">
                    ต้องการลบข้อมูลให้ทำการเลือกที่ รายชือพนักงาน
                    แล้วกดลบผู้ใช้งาน
                  </li>
                  <li class="lh-lg">ต้องการเคลียร์ฟอร์มกดยกเลิก</li>
                </ol>
              </div>
            </div>
          </div>
        </div>

        <div class="page" data-toggle="data_logging_page">
          <p class="page-title">บันทึกการปฏิบัติงาน</p>
          <div id="data_logging" class="dataLogging-container"></div>
        </div>
      </section>
    </main>

    <script src="./js/datatest.js"></script>

    <!-- คลาสที่ใช้ร่วมกัน -->
    <script src="./js/globalScript.js"></script>

    <!-- ชั่งน้ำหนัก 10 เม็ด -->
    <script src="./js/weight10s.js"></script>

    <!-- ชั่งน้ำหนัก ipc -->
    <script src="./js/weightIpc.js"></script>

    <!-- ตั้งค่าน้ำหนักยาของเครื่องตอก -->
    <script src="./js/setupWeight.js"></script>

    <!-- แก้ไขรายชื่อผู้ปฏิบัติงาน -->
    <script>
      class CreateUserDataForm {
        constructor(containerId, userDataLists) {
          this.container = document.getElementById(containerId);
          this.userDataLists = userDataLists;
        }

        // ค้นหาข้อมูลผู้ใช้จากฐานข้อมูลในระบบ
        searchUserData(usernameTH) {
          const results = Object.entries(this.userDataLists).find(
            ([rfid, data]) => {
              return usernameTH == data.usernameTH;
            }
          );

          if (results) {
            const [rfid, data] = results;
            const elements = $(this.container).find(
              "input:not([name='password']), select:not([name='usernameList'])"
            );
            elements.each((index, element) => {
              const el = $(element);
              if (index == 0) {
                el.val(rfid);
              } else {
                el.val(data[$(element).attr("name")]);
              }
            });
          }
        }

        // สร้างรายการจากชื่อยา
        createDropdownList(userDataLists) {
          if (userDataLists) {
            this.userDataLists = userDataLists;
          }

          const element = $(this.usernameList)[0].firstChild;
          Object.entries(this.userDataLists).forEach(([rfid, data]) => {
            const options = document.createElement("option");
            options.value = data.usernameTH;
            options.innerText = data.usernameTH;
            element.appendChild(options);
          });

          $(element).change((event) => {
            this.searchUserData(event.target.value);
          });
        }

        // สร้าง tag input รับข้อมูล
        createInputOuterBorder({ id, placeholder }) {
          const container = document.createElement("div");
          container.classList.add("input-outer-border");

          const input = document.createElement("select");
          input.classList.add("form-select");
          const options = document.createElement("option");
          options.value = "";
          options.innerText = placeholder;
          options.selected = true;
          input.appendChild(options);

          input.name = id;
          container.appendChild(input);
          return container;
        }

        // สร้าง tag input รับข้อมูล
        createInput({ id, type, dropdownList, options }) {
          const container = document.createElement("div");
          container.classList.add("input-group");

          var input;
          if (type === "select") {
            input = document.createElement("select");
            input.classList.add("form-select");
            input.required = true;
            const option = document.createElement("option");
            option.value = "";
            option.innerText = options.placeholder;
            option.selected = true;
            input.appendChild(option);

            if (dropdownList) {
              dropdownList.forEach((option) => {
                const options = document.createElement("option");
                options.value = option;
                options.innerText = option;
                input.appendChild(options);
              });
            }
          } else {
            input = document.createElement("input");
            input.classList.add("form-control");
            input.type = type;
            input.required = true;

            Object.entries(options).forEach(([option, value]) => {
              input[option] = value;
            });
          }

          // input.id = id;
          input.name = id;
          container.appendChild(input);

          return container;
        }

        // สร้าง tag input รับข้อมูล
        createInputGroup({ label, input }) {
          const container = document.createElement("div");
          container.className = "input-group-row";
          const _label = document.createElement("a");
          _label.className = "input-group-label";
          _label.textContent = label;

          const input_group = document.createElement("div");
          input_group.className = "group-row";
          const _input = this.createInput(input);
          container.appendChild(_label);
          input_group.appendChild(_input);
          container.appendChild(input_group);
          return container;
        }

        // สร้างฟอร์ม
        createFormUserData() {
          const form = document.createElement("form");
          const container_header = document.createElement("div");
          container_header.className = "form-header-group";

          this.usernameList = this.createInputOuterBorder({
            id: "usernameList",
            placeholder: "รายชื่อพนักงาน...",
          });

          container_header.appendChild(this.usernameList);

          const delete_button = document.createElement("button");
          delete_button.className = "btn btn-danger";
          delete_button.type = "button";
          delete_button.textContent = "ลบข้อมูล";
          container_header.appendChild(delete_button);
          form.appendChild(container_header);
          form.appendChild(document.createElement("hr"));

          const title = document.createElement("p");
          title.className = "form-title";
          title.textContent = "ข้อมูลพนักงาน";
          form.appendChild(title);

          // รหัสบัตรพนักงาน 10 หลัก
          const rfid = this.createInputGroup({
            label: "รหัสบัตรพนักงาน 10 หลัก",
            input: {
              id: "rfid",
              type: "tel",
              options: {
                placeholder: "RFID...",
                minLength: "10",
                maxLength: "10",
                pattern: "[0-9]+",
              },
            },
          });
          form.appendChild(rfid);

          // รหัสพนักงาน
          const employeeId = this.createInputGroup({
            label: "รหัสพนักงาน",
            input: {
              id: "employeeId",
              type: "tel",
              options: { placeholder: "รหัสพนักงาน..." },
            },
          });
          form.appendChild(employeeId);

          // ชื่อภาษาไทย
          const usernameTH = this.createInputGroup({
            label: "ชื่อภาษาไทย",
            input: {
              id: "usernameTH",
              type: "text",
              options: {
                placeholder: "ชื่อภาษาไทย...",
                pattern: "[\u0E00-\u0E7F]+",
              },
            },
          });
          form.appendChild(usernameTH);

          // ชื่อภาษาอังกฤษ
          const usernameEN = this.createInputGroup({
            label: "ชื่อภาษาอังกฤษ",
            input: {
              id: "usernameEN",
              type: "text",
              options: {
                placeholder: "ชื่อภาษาอังกฤษ...",
                pattern: "[a-zA-Z]+",
              },
            },
          });
          form.appendChild(usernameEN);

          // รหัสผ่าน
          this.password = this.createInputGroup({
            label: "รหัสผ่าน",
            input: {
              id: "password",
              type: "password",
              options: {
                placeholder: "รหัสผ่าน...",
                autocomplete: false,
                required: false,
              },
            },
          });
          form.appendChild(this.password);

          // สิทธิการใช้งาน
          const role = this.createInputGroup({
            label: "สิทธิการใช้งาน",
            input: {
              id: "role",
              type: "select",
              dropdownList: [
                "Admin",
                "Superuser",
                "Operator",
                "Inspector",
                "Retirement",
              ],
              options: { placeholder: "สิทธิการใช้งาน..." },
            },
          });
          form.appendChild(role);

          const containerSubmitForm = document.createElement("div");
          containerSubmitForm.className = "form-submit-group";
          const submitForm = document.createElement("button");
          submitForm.className = "btn btn-success";
          submitForm.type = "submit";
          submitForm.textContent = "บันทึกข้อมูล";
          containerSubmitForm.appendChild(submitForm);

          const resetForm = document.createElement("button");
          resetForm.className = "btn btn-danger";
          resetForm.type = "reset";
          resetForm.textContent = "ยกเลิก";
          containerSubmitForm.appendChild(resetForm);
          form.appendChild(containerSubmitForm);

          this.container.appendChild(form);

          // สร้าง dropdown รายชื่อพนักงาน
          this.createDropdownList();

          // EventListener
          $(document).ready(function () {
            // ลบข้อมูลผู้ใช้งาน
            $(delete_button).click(() => {
              SwalPopup.fire({
                title: "ลบข้อมูลผู้ใช้งาน!",
                text: "ต้องการลบข้อมูลผู้ใช้งาน",
              }).then(deleteUser);
            });

            // เพิ่มหรือแก้ไขข้อมูลผู้ใช้งาน
            $(form).submit((e) => {
              e.preventDefault();
              addOrEditUser();
            });
          });

          // ยืนยันการลบข้อมูลผู้ใช้งานออกจากฐานข้อมูล
          function deleteUser(res) {
            if (res.isConfirmed) {
              loadingTrash("show");
              setTimeout(function () {
                SwalAlert.fire({ text: "ลบข้อมูล! ออกจากระบบเรียบร้อยแล้ว" });
                loadingTrash("hide");
              }, 2500);
            }
          }

          // เพิ่มหรือแก้ไขข้อมูลผู้ใช้งาน
          function addOrEditUser(res) {
            loadingEdit("show");
            setTimeout(function () {
              SwalAlert.fire({
                text: "เพิ่ม, แก้ไขข้อมูล ประวิตร rfid: 9876543210 เรียบร้อยแล้ว",
              });
              loadingEdit("hide");
            }, 2500);
          }
        }
      }
    </script>

    <!-- บันทึกการปฏิบัติงาน -->
    <script>
      class CreateDataLogging {
        constructor(containerId, options) {
          this.container = document.getElementById(containerId);
          this.setupTable = options.setupTable;
          this.tableId = options.tableId;
          this.title = options.title;
          this.headers = options.headers;
        }

        // โหลดข้อมูล บันทึกการปฏิบัติงาน
        loadDataLogging() {
          loadingPage("show");

          setTimeout(
            function () {
              loadingPage("hide");
              SwalMiniAlert.fire({ title: "อัพเดทข้อมูลเรียบร้อยแล้ว" });
              this.render(dataLog);
            }.bind(this),
            2500
          );
        }

        render(dataset) {
          this.dataset = dataset;

          if (this.container.innerHTML != "") {
            $(this.container).hide();
            this.container.innerHTML = "";
          }

          this.renderTable();
          $(this.container).fadeIn(1500);

          $(this.buttonUpdate).click(
            function () {
              this.loadDataLogging();
            }.bind(this)
          );
        }

        // สร้างตาราง
        renderTable() {
          const tableCreator = new CreateTable(this.tableId); // Create table instance
          const table = tableCreator.table; // Get the created table element
          table.classList.add("dataLogging-table", "cell-border");

          // Create table header
          const thead = document.createElement("thead");
          const title_headerRow = document.createElement("tr");
          const headerRow = document.createElement("tr");
          Object.entries(this.headers).forEach(([key, header], index) => {
            if (index == 0) {
              const datetime = document.createElement("th");
              datetime.setAttribute("rowspan", "2");
              datetime.textContent = header;

              const title = document.createElement("th");
              title.classList.add("table-title");
              title.setAttribute("colspan", "7");
              title.textContent = this.title;

              title_headerRow.appendChild(datetime);
              title_headerRow.appendChild(title);
              headerRow.appendChild(title_headerRow);
            } else {
              const th = document.createElement("th");
              th.textContent = header;
              headerRow.appendChild(th);
            }
          });

          thead.appendChild(title_headerRow);
          thead.appendChild(headerRow);

          this.buttonUpdate = document.createElement("button");
          this.buttonUpdate.type = "button";
          this.buttonUpdate.className = "btn btn-warning";
          this.buttonUpdate.textContent = "อัพเดท";
          thead.appendChild(this.buttonUpdate);

          table.appendChild(thead);

          // Create table body
          this.tbody = document.createElement("tbody");

          Object.entries(this.dataset).forEach(([timestamp, rowData]) => {
            const row = document.createElement("tr");
            Object.entries(this.headers).forEach(([key, header], index) => {
              const cell = document.createElement("td");
              const data = rowData[key];

              // timestamp
              if (index === 0) {
                cell.textContent = timestamp;
              } else {
                cell.textContent = data || "";
              }
              row.appendChild(cell);
            });

            this.tbody.appendChild(row);
          });

          table.appendChild(this.tbody);

          // Append table to container
          this.container.appendChild(table);

          // สร้างตาราง DataTable
          const tableID = this.tableId;
          $(document).ready(
            function () {
              $(`#${tableID}`).DataTable().destroy();
              this.table = $(`#${tableID}`).DataTable(setupTable);
            }.bind(this)
          );
        }
      }
    </script>

    <script src="./js/testScript.js"></script>

    <!-- loading, success, failed -->
    <script>
      function loadingPage(command) {
        switch (command) {
          case "show":
            $(".loading-page").fadeIn();
            break;
          case "hide":
            $(".loading-page").fadeOut();
            break;
          default:
            break;
        }
      }

      function loadingTrash(command) {
        switch (command) {
          case "show":
            $(".loading-trash").fadeIn();
            break;
          case "hide":
            $(".loading-trash").fadeOut();
            break;
          default:
            break;
        }
      }

      function loadingEdit(command) {
        switch (command) {
          case "show":
            $(".loading-edit").fadeIn();
            break;
          case "hide":
            $(".loading-edit").fadeOut();
            break;
          default:
            break;
        }
      }

      const SwalPopup = Swal.mixin({
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "ยืนยัน, ลบข้อมูล!",
        cancelButtonText: "ยกเลิก",
      });

      const SwalAlert = Swal.mixin({
        title: "ดำเนินการเรียบร้อย",
        icon: "success",
        showConfirmButton: false,
        timer: 2500,
      });

      const SwalMiniAlert = Swal.mixin({
        toast: true,
        icon: "success",
        title: "ดำเนินการเรียบร้อยแล้ว",
        position: "top-end",
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
      });
    </script>

    <!--Js Datatable-->
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>

    <!--Js Bootstrap-->
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
