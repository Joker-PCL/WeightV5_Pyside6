<div class="login-page d-none">
  <main class="form-signin container m-auto">
    <form autocomplete="off">
      <img
        class="mb-4"
        src="https://lh5.googleusercontent.com/d/1Q3dvsyhV6mIITRURLEA5y_0066FQ8762"
        alt=""
        width="100px"
        height="100px"
      />
      <h1 class="h3 mb-4 fw-bolder">ลงชื่อเข้าสู่ระบบ</h1>

      <div class="form-input was-validated mb-3">
        <label for="username" class="form-label">
          ชื่อผู้ใช้งาน
          <span class="text-danger ps-2"></span>
        </label>
        <input
          type="text"
          class="form-control"
          id="username"
          name="username"
          placeholder="username"
          autocomplete="off"
          required
        />
      </div>
      <div class="form-input was-validated mb-3">
        <label for="password" class="form-label">
          รหัสผ่าน
          <span class="text-danger ps-2"></span>
        </label>
        <input
          type="password"
          class="form-control"
          id="password"
          name="password"
          placeholder="password"
          autocomplete="off"
          required
        />
      </div>
      <button class="w-100 py-2 mt-3" type="submit">เข้าสู่ระบบ</button>
    </form>
  </main>
</div>

<script>
  const form = document.querySelector("form");
  const usernameEl = document.querySelector("#username");
  const passwordEl = document.querySelector("#password");
  const submitButton = document.querySelector("button[type='submit']");

  $(document).ready(function () {
    if (localStorage.getItem("jsonWebToken")) {
      loadingPage("show");
      google.script.run
        .withSuccessHandler((res) => {
          loadingPage("hide");
          if (res.message === "success") {
            localStorage.setItem("jsonWebToken", res.jsonWebToken);
            localStorage.setItem("userData", res.userData);
            createSidebarMenu(res.userData);
            $(".login-page").addClass("d-none");
            $(".main-pages").removeClass("d-none");
          } else {
            console.log(res.message);
            localStorage.clear();
            $(".login-page").removeClass("d-none");
            $(".main-pages").addClass("d-none");
          }
        })
        .validateToken(localStorage.getItem("jsonWebToken"));
    } else {
      $(".login-page").removeClass("d-none");
      $(".main-pages").addClass("d-none");
    }
  });

  form.addEventListener("submit", function (e) {
    e.preventDefault();
    submitButton.innerHTML = "กำลังตรวจสอบข้อมูล";
    submitButton.disabled = true;
    google.script.run
      .withSuccessHandler((res) => {
        submitButton.disabled = true;

        if (res.message === "success") {
          localStorage.setItem("jsonWebToken", res.jsonWebToken);
          localStorage.setItem("userData", res.userData);
          createSidebarMenu(res.userData);
          $(".login-page").addClass("d-none");
          $(".main-pages").removeClass("d-none");
        } else {
          submitButton.innerHTML = "เข้าสู่ระบบ";
          localStorage.clear();
          console.log(res.message);

          if (res.message === "password is incorrect!") {
            const passwordSpan = passwordEl
              .closest(".form-input")
              .querySelector("span");
            passwordSpan.textContent = "รหัสผ่านไม่ถูกต้อง";
          } else {
            const usernameSpan = usernameEl
              .closest(".form-input")
              .querySelector("span");
            usernameSpan.textContent = "ไม่พบข้อมูลผู้ใช้งาน";
          }
        }
      })
      .login(form);
  });

  usernameEl.addEventListener("keyup", function () {
    const usernameSpan = usernameEl
      .closest(".form-input")
      .querySelector("span");
    usernameSpan.textContent = "";
  });

  passwordEl.addEventListener("keyup", function () {
    const passwordSpan = passwordEl
      .closest(".form-input")
      .querySelector("span");
    passwordSpan.textContent = "";
  });
</script>
